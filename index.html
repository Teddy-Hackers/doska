<html>

<head>
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <link rel="stylesheet" type="text/css" href="style.css">

  <script type='text/javascript'>
    var url = window.location.href;
    var searchParams = new URLSearchParams(url.split('?')[1]);

    function fill_tasks_table(data, view) {
      var table = document.getElementById("tasks_table");
      table.innerHTML = "";

      if (view.localeCompare("admin") == 0) {

      } else {  // User view
        var row = table.insertRow();
        data.forEach((pull) => {
          var cell = row.insertCell();
          cell.innerHTML = "<a href=" + pull.html_url + ">link</a>";;
          if (pull.status.localeCompare("success") == 0) {
            cell.bgColor = 'green';
          } else if (pull.status.localeCompare("failure") == 0) {
            cell.bgColor = 'red';
          }
        });
      }
    }

    function main() {
    if (searchParams.has("code")) {
      $.ajax({
        type: 'GET',
        dataType: 'json',
        url: "https://teddy-hackers-doska.herokuapp.com?code=" + searchParams.get("code"),
        // url: "http://localhost:56582/?code=" + searchParams.get("code"),
      }).done(function(res) {
        $("#myname").html("Hello, " + res.name + "!");

        var projects_table = document.getElementById("projects_table");
        for (let name in res.repos) {
          var project = projects_table.insertRow().insertCell();
          project.innerHTML = name;
          project.addEventListener("click", function() {
            fill_tasks_table(res.repos[name], res.view);
          });
        }
      });

      window.history.replaceState("", "", url.split('?')[0]);
    } else {
      // Redirect to GitHub login page
      window.location.replace("https://github.com/login/oauth/authorize?client_id=Iv1.9ecbfe62c74137df");
    }
  }

  </script>
</head>

<body onload="main()">
  <p id="myname" style="float: right"></p>

  <div id="panel">

    <div id="projects">
      <p>Started projects</p>

      <form action="https://github.com/apps/doska-helper/installations/new">
        <input type="submit" value="Add private repository" />
      </form>

      <table id="projects_table">
      </table>
    </div>

    <div id="tasks">
      <table id="tasks_table">
        <tr>
          <th>Firstname</th>
          <th>Lastname</th>
          <th>Age</th>
        </tr>
        <tr>
          <td>Jill</td>
          <td>Smith</td>
          <td>50</td>
        </tr>
      </table>
    </div>
  </div>
  <!-- <table id="results"></table><br>

   -->

</body>

</html>
